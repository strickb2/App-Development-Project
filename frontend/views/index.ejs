<!DOCTYPE html>
<html>
  <head>
    <title><%= title %></title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
  </head>
  
  <body>
    <!-- Filters for list -->
    
    <select id="FilterArtist">
      <option value="">Select Artist</option>
    </select>
  
    <select id="FilterGenre">
      <option value="">Select Genre</option>
    </select>

    <select id="FilterLabel">
      <option value="">Select Label</option>
    </select>

    <button onclick="getProductsFilteredBy()">Filter</button>

    <!-- Products -->
    <div id="ProductsContainer" class="col-3">
    </div>
    
    <!------------------------- JavaScript Segment ------------------------->
    <script>
      // ------ Page Elements ------
      const containerProducts = document.getElementById("ProductsContainer");
      const containerArtistFilter = document.getElementById("FilterArtist");
      const containerGenreFilter = document.getElementById("FilterGenre");
      const containerLabelFilter = document.getElementById("FilterLabel");
      
      // ------ Request URLs ------
      const sRequestProducts = "http://127.0.0.1:8000/products/";
      const sRequestArtists = "http://127.0.0.1:8000/artists/";
      const sRequestGenres = "http://127.0.0.1:8000/genres/";
      const sRequestLabels = "http://127.0.0.1:8000/labels/";
      const sRequestBasketItems = "http://127.0.0.1:8000/basketitems/";
      
      function init() {
        // Create the list of filters
        displayArtistsFilters();
        displayLabelsFilters();
        displayGenresFilters();
        
        // Create the list of products
        displayInitProducts();
      };

      // ------ Get Requests ------
      async function getData(url, data=null) {
        if (!data){
          response = await fetch(url);
        } else {
          response = await fetch(url, {mode: 'cors'});
        }
        data = await response.json();
        return data;
      };

      function getProducts() {
        return getData(sRequestProducts);
      };

      function getArtists() {
        return getData(sRequestArtists);
      };
      
      function getGenres() {
        return getData(sRequestGenres);
      };

      function getLabels() {
        return getData(sRequestLabels);
      };

      function getProductsFilteredBy() {
        // Build Request for filtered products
        let sRequestProductsFiltered = "http://127.0.0.1:8000/products/?";

        // Get values of selected filters
        let filterArtist = containerArtistFilter.options[containerArtistFilter.selectedIndex].value;
        let filterGenre = containerGenreFilter.options[containerGenreFilter.selectedIndex].value;
        let filterLabel = containerLabelFilter.options[containerLabelFilter.selectedIndex].value;

        // Check if there are any filters selected
        if (filterArtist || filterGenre || filterLabel) {
          let filters = []
          if (filterArtist) {
            filters.push("artist=" + filterArtist);
          }; 
          if (filterGenre) {
            filters.push("genre=" + filterGenre);
          }; 
          if (filterLabel) {
            filters.push("label=" + filterLabel);
          };
          sRequestProductsFiltered += filters.join("&");
          let promiseProducts = getData(sRequestProductsFiltered, true);
          clearProducts();
          displayProducts(promiseProducts);
        } else {
          alert("No Filters Selected");
        }
      };

      // ------ Populating Functions ------

      // ------ Products ------
      function displayProducts(promiseProducts) {
        promiseProducts.then(oProducts => {
          if (oProducts.length > 0) {
            console.log(oProducts);
            for(let idProduct=0; idProduct<=oProducts.length - 1; idProduct++) {
              let elProductTitle = document.createElement("h3");
              let elProductPrice = document.createElement("p");

              elProductTitle.innerHTML = oProducts[idProduct].name  + " - " + oProducts[idProduct].artist;
              elProductPrice.innerHTML = "â‚¬" + oProducts[idProduct].price;

              containerProducts.appendChild(elProductTitle);
              containerProducts.appendChild(elProductPrice);
            };
          } else {
            console.log("HERE");
            let elProductNotFound = document.createElement("h3");

            elProductNotFound.innerHTML = "No Products Found."

            containerProducts.appendChild(elProductNotFound);
          }
        });
      };

      // ------ All Filters ------
      function displayFilters(promiseData, containerFilter) {
        promiseData.then(oOptions => {
          for(let idOption=0; idOption<=oOptions.length - 1; idOption++) {
            elOption = document.createElement("option");
            elOption.value = oOptions[idOption].id;

            elOption.innerHTML = oOptions[idOption].name;

            containerFilter.appendChild(elOption);
          }
        });
      }
      
      function displayArtistsFilters() {
        promiseArtists = getArtists();
        displayFilters(promiseArtists, containerArtistFilter);
      };

      function displayGenresFilters(oGenres) {
        promiseGenres = getGenres();
        displayFilters(promiseGenres, containerGenreFilter);
      };

      function displayLabelsFilters(oLabels) {
        promiseLabels = getLabels();
        displayFilters(promiseLabels, containerLabelFilter);
      };
      
      function displayInitProducts() {
        promiseProducts = getProducts();
        displayProducts(promiseProducts);
      };

      // ------ UnPopulating Functions ------
      function clearContainer(container) {
        container.innerHTML = "";
      };

      function clearProducts() {
        clearContainer(containerProducts);
      }

      init();
    </script>
  </body>
</html>
